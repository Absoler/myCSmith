#! /bin/bash
default_option=
test_type=
pin_root=
root_dir=
host_root_dir=

# --------------------------------------
#   argv[1] must be full compiler name or docker image name
#   such as 'gcc-13.2.0' or 'gcc:10.1.0'
#
#   [optional]: argv[2] is the mount directory inside the container,
#   if in host, set the same as `host_root_dir`
# --------------------------------------

if [[ $1 =~ - ]] ; then
    if [[ $1 =~ -O ]] ; then
        default_option=""
    fi
    ${1//+/ } output2.c -I $root_dir/runtime -gdwarf-4 $default_option -w -o output2
else
    if [ $# -lt 2 ] ; then echo "need input mount position!" ; fi
    cwd=`pwd`
    cwd_fromhost=$host_root_dir/${cwd##$2}
    docker run --rm -v $cwd_fromhost:/root -w /root $1 ${1%%:*} /root/output2.c $default_option -gdwarf-4 -o output2 2>/dev/null
fi
$pin_root/pin -t $root_dir/checkAccess/obj-intel64/checkAccess.so -- ./output2 $test_type func ./
objdump -dl --no-show-raw-insn  output2 > disas